FROM debian:bookworm

ARG DEBIAN_FRONTEND=noninteractive

RUN rm -rf /var/lib/apt/lists/* \
    && apt-get update \
    && apt-get install -qq -y gnupg wget apt-transport-https make supervisor git iproute2 procps

# kamailio repo
RUN echo "deb http://deb.kamailio.org/kamailio57 bookworm main" >   /etc/apt/sources.list.d/kamailio.list \
    && wget -O /tmp/kamailiodebkey.gpg http://deb.kamailio.org/kamailiodebkey.gpg &&   gpg --output /etc/apt/trusted.gpg.d/deb-kamailio-org.gpg --dearmor /tmp/kamailiodebkey.gpg \
    && apt-get update \
    && apt-get install -qq -y kamailio=5.7.5+bpo12 kamailio-autheph-modules=5.7.5+bpo12 kamailio-berkeley-bin=5.7.5+bpo12 kamailio-berkeley-modules=5.7.5+bpo12 kamailio-cnxcc-modules=5.7.5+bpo12 kamailio-cpl-modules=5.7.5+bpo12 kamailio-dbg=5.7.5+bpo12 kamailio-erlang-modules=5.7.5+bpo12 kamailio-extra-modules=5.7.5+bpo12 kamailio-geoip-modules=5.7.5+bpo12 kamailio-geoip2-modules=5.7.5+bpo12 kamailio-ims-modules=5.7.5+bpo12 kamailio-json-modules=5.7.5+bpo12 kamailio-kazoo-modules=5.7.5+bpo12 kamailio-ldap-modules=5.7.5+bpo12 kamailio-lua-modules=5.7.5+bpo12 kamailio-lwsc-modules=5.7.5+bpo12 kamailio-memcached-modules=5.7.5+bpo12 kamailio-mongodb-modules=5.7.5+bpo12 kamailio-mono-modules=5.7.5+bpo12 kamailio-mqtt-modules=5.7.5+bpo12 kamailio-mysql-modules=5.7.5+bpo12 kamailio-nats-modules=5.7.5+bpo12 kamailio-nth=5.7.5+bpo12 kamailio-outbound-modules=5.7.5+bpo12 kamailio-perl-modules=5.7.5+bpo12 kamailio-phonenum-modules=5.7.5+bpo12 kamailio-postgres-modules=5.7.5+bpo12 kamailio-presence-modules=5.7.5+bpo12 kamailio-python3-modules=5.7.5+bpo12 kamailio-rabbitmq-modules=5.7.5+bpo12 kamailio-radius-modules=5.7.5+bpo12 kamailio-redis-modules=5.7.5+bpo12 kamailio-ruby-modules=5.7.5+bpo12 kamailio-sctp-modules=5.7.5+bpo12 kamailio-secsipid-modules=5.7.5+bpo12 kamailio-snmpstats-modules=5.7.5+bpo12 kamailio-sqlite-modules=5.7.5+bpo12 kamailio-systemd-modules=5.7.5+bpo12 kamailio-tls-modules=5.7.5+bpo12 kamailio-unixodbc-modules=5.7.5+bpo12 kamailio-utils-modules=5.7.5+bpo12 kamailio-websocket-modules=5.7.5+bpo12 kamailio-xml-modules=5.7.5+bpo12 kamailio-xmpp-modules=5.7.5+bpo12   && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install rtpproxy
RUN git clone -b master https://github.com/sippy/rtpproxy.git \
    && git -C rtpproxy submodule update --init --recursive \
    && cd rtpproxy \
    && ./configure \
    && make \
    && make install 
    # && cp scripts/rtpproxy.init.debian /etc/init.d/rtpproxy

# Setup supervisor
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
COPY kamailio.conf /etc/default/kamailio
COPY rtpproxy /etc/init.d/
COPY rtpproxy.conf /etc/default/rtpproxy
RUN chmod +x /etc/init.d/rtpproxy

VOLUME /etc/kamailio

#ENTRYPOINT kamailio -DD -E -m 64 -M 8
CMD ["/usr/bin/supervisord"]
